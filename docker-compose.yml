services:
  postgres:
    container_name: postgres-faith
    image: postgres:latest
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: faith_user
      POSTGRES_PASSWORD: postgres-secure-password
      POSTGRES_DB: faith_db
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/postgres:/var/lib/postgresql
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "faith_user", "-d", "faith_db"]
      interval: 30s
      timeout: 30s
      retries: 5

  etcd:
    container_name: etcd-faith
    image: milvusdb/etcd:latest
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
      - ETCD_LOG_LEVEL=warn
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/etcd:/etcd
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 30s
      retries: 5

  seaweedfs-master:
    container_name: seaweedfs-master-faith
    image: chrislusf/seaweedfs:4.03
    ports:
      - 9333:9333
      - 19333:19333
      - 9324:9324
    command: 'master -ip=seaweedfs-master -ip.bind=0.0.0.0 -metricsPort=9324 -mdir=/data'
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/seaweedfs/master:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9333/cluster/status"]
      interval: 30s
      timeout: 30s
      retries: 5

  seaweedfs-volume:
    container_name: seaweedfs-volume-faith
    image: chrislusf/seaweedfs:4.03
    ports:
      - 8080:8080
      - 18080:18080
      - 9325:9325
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/seaweedfs/volume:/data
    command: 'volume -ip=seaweedfs-volume -master="seaweedfs-master:9333" -ip.bind=0.0.0.0 -port=8080 -metricsPort=9325 -dir=/data'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/status"]
      interval: 30s
      timeout: 30s
      retries: 5
    depends_on:
      seaweedfs-master:
        condition: service_healthy

  seaweedfs-filer:
    container_name: seaweedfs-filer-faith
    image: chrislusf/seaweedfs:4.03
    ports:
      - 8888:8888
      - 18888:18888
      - 9326:9326
    command: 'filer -ip=seaweedfs-filer -master="seaweedfs-master:9333" -ip.bind=0.0.0.0 -metricsPort=9326'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/"]
      interval: 30s
      timeout: 30s
      retries: 5
    tty: true
    stdin_open: true
    depends_on:
      seaweedfs-master:
        condition: service_healthy
      seaweedfs-volume:
        condition: service_healthy

  seaweedfs-s3:
    container_name: seaweedfs-s3-faith
    image: chrislusf/seaweedfs:4.03
    ports:
      - 8333:8333
      - 9327:9327
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
    command: 's3 -filer="seaweedfs-filer:8888" -ip.bind=0.0.0.0 -metricsPort=9327'
    healthcheck:
      test: ["CMD", "curl", "http://localhost:8333/"]
      interval: 30s
      timeout: 30s
      retries: 5
    depends_on:
      seaweedfs-master:
        condition: service_healthy
      seaweedfs-volume:
        condition: service_healthy
      seaweedfs-filer:
        condition: service_healthy

  seaweedfs-init:
    container_name: seaweedfs-init-faith
    image: amazon/aws-cli:latest
    environment:
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_DEFAULT_REGION: us-east-1
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for SeaweedFS S3 to be ready..."
        until aws --endpoint-url=http://seaweedfs-s3:8333 s3 ls 2>/dev/null; do
          echo "SeaweedFS S3 not ready yet, waiting..."
          sleep 2
        done
        echo "Checking if milvus-bucket exists..."
        if aws --endpoint-url=http://seaweedfs-s3:8333 s3api head-bucket --bucket milvus-bucket 2>/dev/null; then
          echo "Bucket milvus-bucket already exists"
        else
          echo "Creating milvus-bucket..."
          if aws --endpoint-url=http://seaweedfs-s3:8333 s3 mb s3://milvus-bucket; then
            echo "Bucket milvus-bucket created successfully"
          else
            echo "ERROR: Failed to create bucket milvus-bucket. Try: docker compose down -v && sudo rm -rf ./volumes"
            exit 1
          fi
        fi
        echo "Bucket initialization complete"
    depends_on:
      seaweedfs-s3:
        condition: service_healthy

  milvus:
    container_name: milvus-faith
    image: milvusdb/milvus:latest
    ports:
      - "19530:19530"
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: seaweedfs-s3:8333
      MINIO_ACCESS_KEY_ID: minioadmin
      MINIO_SECRET_ACCESS_KEY: minioadmin
      MINIO_USE_SSL: "false"
      MINIO_BUCKET_NAME: milvus-bucket
      MINIO_ROOT_PATH: milvus/data
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/milvus:/var/lib/milvus
    command: ["milvus", "run", "standalone"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      start_period: 3600s
      interval: 30s
      timeout: 30s
      retries: 5
    security_opt:
      - seccomp:unconfined
    depends_on:
      etcd:
        condition: service_healthy
      seaweedfs-s3:
        condition: service_healthy
      seaweedfs-init:
        condition: service_completed_successfully
      embedding:
        condition: service_healthy

  embedding:
    container_name: llama-cpp-embedding-faith
    image: ghcr.io/ggml-org/llama.cpp:server-cuda
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/llama_cpp_cache:/root/.cache/huggingface
    ports:
      - "11435:11435"
    environment:
      HF_TOKEN: 
      HF_HOME: /root/.cache/huggingface
      HUGGINGFACE_HUB_CACHE: /root/.cache/huggingface
    command: ["-hf", "Qwen/Qwen3-Embedding-0.6B-GGUF:Q8_0", "-c", "4096", "-ngl", "9999", "--cache-type-k", "q8_0", "--cache-type-v", "q8_0", "--host", "0.0.0.0", "--port", "11435", "--cont-batching", "-np", "1", "--embedding"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11435/health"]
      start_period: 3600s
      interval: 30s
      timeout: 30s
      retries: 5
    deploy:
      resources:
        reservations:
          devices:
            - driver: cdi
              device_ids:
                - nvidia.com/gpu=all
              capabilities: [gpu]

  llm:
    container_name: llama-cpp-llm-faith
    image: ghcr.io/ggml-org/llama.cpp:server-cuda
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/llama_cpp_cache:/root/.cache/huggingface
    ports:
      - "11436:11436"
    environment:
      HF_TOKEN: 
      HF_HOME: /root/.cache/huggingface
      HUGGINGFACE_HUB_CACHE: /root/.cache/huggingface
    command: ["-hf", "unsloth/Qwen3-4B-Instruct-2507-GGUF:Q4_K_M", "-c", "4096", "-ngl", "9999", "--cache-type-k", "q8_0", "--cache-type-v", "q8_0", "--host", "0.0.0.0", "--port", "11436", "--cont-batching", "-np", "1", ]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11436/health"]
      start_period: 3600s
      interval: 30s
      timeout: 30s
      retries: 5
    deploy:
      resources:
        reservations:
          devices:
            - driver: cdi
              device_ids:
                - nvidia.com/gpu=all
              capabilities: [gpu]

  webapp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: webapp-faith
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      POSTGRES_HOST: postgres
      MILVUS_URL: http://milvus
      EMBEDDING_URL: http://embedding
      LLM_URL: http://llm
    command: sh -c "python scripts/docker_milvus_initializer.py && python manage.py migrate && python manage.py collectstatic --noinput --clear && uvicorn fAIth.asgi:application --host 0.0.0.0 --port 8000 --workers 1"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthcheck/"]
      start_period: 3600s
      interval: 30s
      timeout: 30s
      retries: 5
    depends_on:
      postgres:
        condition: service_healthy
      milvus:
        condition: service_healthy
      embedding:
        condition: service_healthy
      llm:
        condition: service_healthy
    volumes:
      - .:/app
